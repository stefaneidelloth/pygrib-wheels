name: Build and upload wheels

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  create:
    tags:

jobs:
  build:
    name: "Build ${{ matrix.os }} ${{ matrix.python-version }} wheels"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13", "3.14", "3.14t"]
        os: [
          ubuntu-latest,       # Linux x86_64
          ubuntu-24.04-arm,   # Linux aarch64
          macos-latest,       # macOS (Apple Silicon runner)
          macos-15-intel,     # macOS Intel runner
          windows-latest      # Windows x86_64
        ]
        include:
          - python-osx-ver: "11.0"
          - os: macos-15-intel
            python-osx-ver: "10.9"
        exclude:
          # Free-threaded cp314t is not (yet) buildable with conda on Windows
          - os: windows-latest
            python-version: "3.14t"

    env:
      REPO_DIR: pygrib
      PKG_NAME: pygrib
      BUILD_COMMIT: rel2.1.8
      UNICODE_WIDTH: 32
      MB_PYTHON_VERSION: ${{ matrix.python-version }}
      TRAVIS_PYTHON_VERSION: ${{ matrix.python-version }}
      MB_ML_VER: 2014
      TRAVIS_REPO_SLUG: ${{ github.repository }}
      TRAVIS_BRANCH: ${{ github.head_ref }}
      TRAVIS_PULL_REQUEST: ${{ github.event.number }}
      TRAVIS_BUILD_DIR: ${{ github.workspace }}
      MULTIBUILD_WHEELS_STAGING_ACCESS: ${{ secrets.MULTIBUILD_WHEELS_STAGING_ACCESS }}

    steps:
      - uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      # ---------- COMMON ENV ----------
      - name: Set common env
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [ "schedule" == "${{ github.event_name }}" ] || [ "master" == "$BUILD_COMMIT" ]; then
            echo "TOKEN=$SCIPY_WHEELS_NIGHTLY_ACCESS" >> "$GITHUB_ENV"
          else
            echo "TOKEN=$MULTIBUILD_WHEELS_STAGING_ACCESS" >> "$GITHUB_ENV"
          fi

          if [ "${{ matrix.os }}" = "macos-latest" ] || [ "${{ matrix.os }}" = "macos-15-intel" ]; then
            echo "TRAVIS_OS_NAME=osx" >> "$GITHUB_ENV"
          elif [[ "${{ matrix.os }}" == ubuntu* ]]; then
            echo "TRAVIS_OS_NAME=linux" >> "$GITHUB_ENV"
          fi

          # PLAT hints for multibuild
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            echo "PLAT=x86_64" >> "$GITHUB_ENV"
          fi
          if [ "${{ matrix.os }}" = "ubuntu-24.04-arm" ]; then
            echo "PLAT=aarch64" >> "$GITHUB_ENV"
          fi
          if [ "${{ matrix.os }}" = "macos-15-intel" ]; then
            echo "PLAT=x86_64" >> "$GITHUB_ENV"
          fi

          if [ "schedule" == "${{ github.event_name }}" ]; then
            echo "TRAVIS_EVENT_TYPE=cron" >> "$GITHUB_ENV"
            echo "BUILD_COMMIT=master" >> "$GITHUB_ENV"
          else
            echo "TRAVIS_EVENT_TYPE=${{ github.event_name }}" >> "$GITHUB_ENV"
            echo "BUILD_COMMIT=$BUILD_COMMIT" >> "$GITHUB_ENV"
          fi

      - name: Linux (x86_64) Docker image for Python 3.14
        if: runner.os == 'Linux' && matrix.os == 'ubuntu-latest' && matrix.python-version == '3.14'
        shell: bash
        run: |
          echo "DOCKER_TEST_IMAGE=multibuild/noble_${PLAT}" >> "$GITHUB_ENV"

      - name: Print debug environment (non-Windows)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "TRAVIS_BRANCH: ${TRAVIS_BRANCH}"
          echo "TRAVIS_PULL_REQUEST: ${TRAVIS_PULL_REQUEST}"
          echo "TRAVIS_REPO_SLUG: ${TRAVIS_REPO_SLUG}"
          echo "TRAVIS_EVENT_TYPE: ${TRAVIS_EVENT_TYPE}"
          echo "TRAVIS_OS_NAME: ${TRAVIS_OS_NAME}"
          echo "PLAT: ${PLAT}"
          echo "DOCKER_TEST_IMAGE: ${DOCKER_TEST_IMAGE}"

      - name: Upgrade pip
        shell: bash
        run: python -m pip install --upgrade pip

      # ---------- LINUX & MACOS: multibuild ----------
      - name: Build wheels with multibuild (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euxo pipefail
          source multibuild/common_utils.sh
          source multibuild/travis_steps.sh

          echo "------- BEFORE INSTALL --------"
          before_install

          echo "------- CLEAN CODE --------"
          clean_code "$REPO_DIR" "$BUILD_COMMIT"

          echo "------- BUILD WHEEL --------"
          build_wheel "$REPO_DIR" "$PLAT"

          echo "------- INSTALL_RUN --------"
          install_run "$PLAT"

          echo "------- LIST WHEELHOUSE --------"
          ls -l wheelhouse/ || true

      # ---------- WINDOWS: conda eccodes + delvewheel ----------
      # Windows builds use conda-forge eccodes (recommended in pygrib docs for Windows)
      # and 'delvewheel repair' to bundle all required DLLs into the wheel.
      - name: Set up Mambaforge (Windows)
        if: runner.os == 'Windows'
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-variant: Mambaforge
          miniforge-version: latest
          channels: conda-forge
          channel-priority: strict
          activate-environment: build
          python-version: ${{ matrix.python-version }}

      - name: Install ecCodes and build deps (Windows)
        if: runner.os == 'Windows'
        shell: bash -l {0}
        run: |
          mamba install -y eccodes cmake ninja zlib libpng openjpeg
          python -m pip install -U pip build delvewheel numpy cython pyproj

      - name: Build wheel (Windows) with ecCodes from conda
        if: runner.os == 'Windows'
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          # Point pygrib's build to ecCodes from conda
          export ECCODES_DIR="${CONDA_PREFIX}/Library"
          cd "$GITHUB_WORKSPACE/${REPO_DIR}"
          python -m build --wheel -n
          mkdir -p "$GITHUB_WORKSPACE/wheelhouse"
          # Bundle DLLs from ecCodes into the wheel using delvewheel
          WHEEL_PATH=$(ls dist/pygrib-*.whl)
          python -m delvewheel repair --add-path "${CONDA_PREFIX}/Library/bin" -w "$GITHUB_WORKSPACE/wheelhouse" "$WHEEL_PATH"
          ls -l "$GITHUB_WORKSPACE/wheelhouse"

      # ---------- ARTIFACTS ----------
      - name: Upload built wheels as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pygrib-wheels-${{ matrix.os }}-${{ matrix.python-version }}
          path: wheelhouse/*.whl
          if-no-files-found: error

      # ---------- RELEASE ON TAG (optional) ----------
      - name: Upload wheels to GitHub Release
        uses: svenstaro/upload-release-action@v2
        if: github.event_name == 'create'
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ github.workspace }}/wheelhouse/pygrib*whl
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true